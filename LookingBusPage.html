<!DOCTYPE html>
<html>
	<head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

		<title>LookingBus - Making Public Transportation Accessible for People with Visual Impairments</title>
        <link rel="icon" type="image/x-icon" href="images/lookingbus(2).jpg">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

        <!-- Our Custom CSS -->
        <link rel="stylesheet" type="text/css" href="LookingBusPage.css">

        <!-- Scrollbar Custom CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">

        <!-- JS, Popper.js, and jQuery -->
        <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

        <!-- jQuery Custom Scroller CDN -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-drawer/1.0.6/js/drawer.min.js"></script>

        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

        <!-- Map API -->
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcj2_3-CK6Wsy8xsa6MBetFNRTVekb-aM&callback=initMap"> </script>

        <!-- <script src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script> -->
        <script src="https://canvasjs.com/assets/script/jquery.canvasjs.min.js"></script>


        <script type="text/javascript">
            var w = $(window).width();
            $('.content').css('width', w);

            $(document).ready(function () {
                $('#sidebarCollapse').on('click', function () {
                    $('#sidebar').toggleClass('active');
                });
            });

            $(document).ready(function () {
                $("#bottomdrawer").mCustomScrollbar({
                    theme: "minimal"
                });

                $('#dismiss, .overlay').on('click', function () {
                    $('#bottomdrawer').removeClass('active');
                    $('.overlay').removeClass('active');
                });
                
                $('#bottomdrawerCollapse').on('click', function () {
                    $('#bottomdrawer').addClass('active');
                    $('.overlay').addClass('active');
                    $('.collapse.in').addClass('in');
                    $('a[aria-expanded=true]').attr('aria-expanded', 'false');
                });

                var options = {
                    animationEnabled: true,  
                    title:{ text: "Monthly Sales - 2017" },
                    axisX: { valueFormatString: "MMM" },
                    axisY: { title: "Sales (in USD)", prefix: "$", includeZero: false },
                    data: [{
                        yValueFormatString: "$#,###",
                        xValueFormatString: "MMMM",
                        type: "spline",
                        dataPoints: [
                            { x: new Date(2017, 0), y: 25060 },
                            { x: new Date(2017, 1), y: 27980 },
                            { x: new Date(2017, 2), y: 33800 },
                            { x: new Date(2017, 3), y: 49400 },
                            { x: new Date(2017, 4), y: 40260 },
                            { x: new Date(2017, 5), y: 33900 },
                            { x: new Date(2017, 6), y: 48000 },
                            { x: new Date(2017, 7), y: 31500 },
                            { x: new Date(2017, 8), y: 32300 },
                            { x: new Date(2017, 9), y: 42000 },
                            { x: new Date(2017, 10), y: 52160 },
                            { x: new Date(2017, 11), y: 49400 }
                        ]
                    }]
                };
                $("#chartContainer").CanvasJSChart(options);
            });

            var polypoints = {};
            var datapoints = [];
            var way_points = [];

            function initMap() {            
                fetch('http://api.511.org/transit/timetable?api_key=08baff0c-3159-436f-8bf1-d97dd5273def&operator_id=SC&line_id=22&format=JSON').then(function (response) {
                            return response.json();
                }).then(function (obj) {
                    // console.log("fetch id");
                    // console.log(obj);
                    obj.Content.ServiceFrame.routes.Route[2].pointsInSequence.PointOnRoute.forEach(/*myfunction);*/function(item) {
                        // console.log(item.PointRef.ref)
                        datapoints.push(item.PointRef.ref);
                        polypoints[item.PointRef.ref] = 0;
                        // polypoints.push({
                        //     key: item.PointRef.ref,
                        //     value: " "
                        // });
                    });
                    console.log(datapoints);
                    // var route = new google.maps.LatLng(37.7749, 122.4194);
                    // var mapProp= { center: route, zoom: 13, };
                    // var map = new google.maps.Map(document.getElementById("googleMap"),mapProp);
                    // var marker = new google.maps.Marker({position: route, map: map});
                }).catch(function (error) {
                    console.error('Something went wrong');
                });

                fetch('http://api.511.org/transit/stops?api_key=08baff0c-3159-436f-8bf1-d97dd5273def&operator_id=SC&format=JSON').then(function (response) {
                    return response.json();
                }).then(function (obj) {
                    console.log("fetch Loc");
                    console.log(obj);
                    // for(var x in datapoints){
                    //     console.log(datapoints[x]);
                    // }
                    obj.Contents.dataObjects.ScheduledStopPoint.forEach(function(item) {
                        // console.log(item);
                        // console.log(item.Location);
                        datapoints.forEach(function(point) {
                            // console.log("works");
                            if(item.hasOwnProperty("id")){
                                // console.log("prop");
                                if(item.id == point){
                                    // console.log("if");
                                    polypoints[point] = item;
                                } else{
                                    // console.log("else");
                                    return;
                                }
                            } else {
                                console.log("no prop");
                            }
                        });
                    });
                    console.log(polypoints);
                    console.log(datapoints[Math.floor(datapoints.length/2)]);
                    return routeDisplay();
                }).catch(function (error) {
                    console.error('Something went wrong1');
                });
            }

            function routeDisplay() {
                var directionsService = new google.maps.DirectionsService();
                var directionsRenderer = new google.maps.DirectionsRenderer();
                // console.log("routeDisplay");
                // console.log(polypoints);
                midpoint = datapoints[Math.floor(datapoints.length/2)];
                
                var route = new google.maps.LatLng(polypoints[midpoint].Location.Latitude, polypoints[midpoint].Location.Longitude);
                var map = new google.maps.Map(document.getElementById('map'), { zoom: 15, center: route });
                directionsRenderer.setMap(map);

                // only first & last point
                var origin = new google.maps.LatLng(polypoints[datapoints[0]].Location.Latitude, polypoints[datapoints[0]].Location.Longitude);
                var destination = new google.maps.LatLng(polypoints[datapoints[datapoints.length-1]].Location.Latitude, polypoints[datapoints[datapoints.length-1]].Location.Longitude);

                for(var i = 1; i < datapoints.length-1; i++){
                    var marker = new google.maps.Marker({position: new google.maps.LatLng(polypoints[datapoints[i]].Location.Latitude, polypoints[datapoints[i]].Location.Longitude), map: map});
                    way_points.push({
                        location: new google.maps.LatLng(polypoints[datapoints[i]].Location.Latitude, polypoints[datapoints[i]].Location.Longitude)});
                }   
                console.log(way_points);
                 calculateAndDisplayRoute(directionsService, directionsRenderer, origin, destination);
                
            }

            function calculateAndDisplayRoute(directionsService, directionsRenderer, o, d) {
                directionsService.route({
                    origin: o, destination: d, waypoints: way_points, optimizeWaypoints: true,
                    travelMode: 'DRIVING'
                },
                function(response, status) {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(response);
                        console.log("waypoints This works");
                    } else {
                        window.alert('Directions request failed due to ' + status);
                    }
                });
            }
        </script>
	</head>

	<body id="page-top" data-gr-c-s-loaded="true" class="has-drawer">
        <!-- <p> Hello There </p> -->

        <div class="overlay"></div>

        <nav id="bottomdrawer">
            <div id="dismiss">
                <i class="fa fa-arrow-down" aria-hidden="true"></i>
            </div>

            <div class="bottomdrawer-header">
                <h3>Bootstrap bottomdrawer</h3>
                <div id="chartContainer" style="height:250px; width: 100%;"></div>
            </div>
        </nav>

        <div class="wrapper">
            <!-- Sidebar Holder -->
            <nav id="sidebar" class="sticky-top">
                <!-- <div class="sidebar-header">
                    Meh
                </div> -->

                <ul class="list-unstyled components">
                    <li class="active">
                        <a href="#homeSubmenu" data-toggle="collapse" aria-expanded="false">
                            <i class="fa fa-home"></i>  Home</a>
                        <ul class="collapse list-unstyled" id="homeSubmenu">
                            <li><a href="#">Home 1</a></li>
                            <li><a href="#">Home 2</a></li>
                            <li><a href="#">Home 3</a></li>
                        </ul>
                    </li>
                    <li><a href="#"><i class="fa fa-briefcase"></i>  About</a></li>
                    <li>
                        <a href="#pageSubmenu" data-toggle="collapse" aria-expanded="false">
                            <i class="fa fa-copy"></i>  Pages</a>
                        <ul class="collapse list-unstyled" id="pageSubmenu">
                            <li><a href="#">Page 1</a></li>
                            <li><a href="#">Page 2</a></li>
                            <li><a href="#">Page 3</a></li>
                        </ul>
                    </li>
                    <li><a href="#"><i class="fa fa-link"></i>  Portfolio</a></li>
                    <li><a href="#"><i class="fa fa-paperclip"></i>  FAQ</a></li>
                    <li><a href="#"><i class="fa fa-paper-plane"></i>  Contact</a></li>
                </ul>

                <ul class="list-unstyled CTAs">
                    <li><a href="https://bootstrapious.com/tutorial/files/sidebar.zip" class="download">Download source</a></li>
                    <li><a href="https://bootstrapious.com/p/bootstrap-sidebar" class="article">Back to article</a></li>
                </ul>
            </nav>

            <!-- Content -->
            <div id="content">

                <!-- NavBar -->
                <nav class="navbar navbar-expand-lg d-flex justify-content-around sticky-top">
                    <div class="container">
                        <img  id="sidebarCollapse" src="images/lookingbus.png" alt="LookingBus">

                        <img  id="bottomdrawerCollapse" src="images/chart.png" alt="Chart">

                        <button class="navbar-toggler navbar-toggler-right collapsed" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                            Menu
                            <i class="fa fa-bars"></i>
                        </button>

                        <div class="collapse navbar-collapse" id="navbarResponsive" >
                            <ul class="navbar-nav ml-auto">
                                <li class="nav-item">
                                    <a class="nav-link js-scroll-trigger" href="#features">Features</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link js-scroll-trigger" href="#news">News</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link js-scroll-trigger" href="#contact">Contact</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>

                <!-- Map -->
                <div id="map"></div>
            </div>
        </div>
	</body> 
</html>